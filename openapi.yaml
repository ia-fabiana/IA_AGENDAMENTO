openapi: 3.0.3
info:
  title: IA_AGENDAMENTO API
  description: |
    API REST para o sistema IA_AGENDAMENTO - Gestão Inteligente de Agendamentos.
    
    Sistema completo de gerenciamento de agendamentos com integração ao Google Calendar
    e controle de acesso baseado em funções (RBAC).
  version: 1.0.0
  contact:
    name: IA_AGENDAMENTO Support
  license:
    name: MIT

servers:
  - url: http://localhost:3001
    description: Servidor de Desenvolvimento
  - url: https://api.ia-agendamento.com
    description: Servidor de Produção

tags:
  - name: Health
    description: Endpoints de status do servidor
  - name: Appointments
    description: Gerenciamento de agendamentos
  - name: Calendar
    description: Integração com Google Calendar
  - name: Authentication
    description: Autenticação e autorização de usuários

paths:
  /health:
    get:
      tags:
        - Health
      summary: Verifica status do servidor
      description: Retorna informações sobre o status e tempo de atividade do servidor
      responses:
        '200':
          description: Servidor saudável
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                    example: '2026-01-30T17:00:00.000Z'
                  uptime:
                    type: number
                    description: Tempo de atividade em segundos
                    example: 1234.56

  /api/appointments:
    post:
      tags:
        - Appointments
      summary: Cria um novo agendamento
      description: |
        Cria um novo agendamento e opcionalmente sincroniza com Google Calendar
        se o tenant tiver a integração habilitada.
      security:
        - userAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - tenantId
                - appointment
              properties:
                userId:
                  type: string
                  format: uuid
                  description: ID do usuário autenticado
                tenantId:
                  type: string
                  format: uuid
                  description: ID do tenant
                appointment:
                  $ref: '#/components/schemas/AppointmentInput'
      responses:
        '200':
          description: Agendamento criado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  appointment:
                    $ref: '#/components/schemas/Appointment'
                  googleCalendarSynced:
                    type: boolean
                    description: Indica se foi sincronizado com Google Calendar
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/appointments/{tenantId}:
    get:
      tags:
        - Appointments
      summary: Lista agendamentos de um tenant
      description: Retorna todos os agendamentos de um tenant específico
      security:
        - userAuth: []
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID do tenant
        - name: userId
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: ID do usuário autenticado
      responses:
        '200':
          description: Lista de agendamentos
          content:
            application/json:
              schema:
                type: object
                properties:
                  appointments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Appointment'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/appointments/{id}:
    delete:
      tags:
        - Appointments
      summary: Deleta um agendamento
      description: |
        Deleta um agendamento e remove do Google Calendar se estiver sincronizado
      security:
        - userAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID do agendamento
        - name: userId
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: ID do usuário autenticado
        - name: tenantId
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: ID do tenant
      responses:
        '200':
          description: Agendamento deletado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '207':
          description: Agendamento deletado mas falha na sincronização do Google Calendar
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  warning:
                    type: string
                    example: Appointment deleted but Google Calendar sync failed
                  error:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/calendar/auth-url:
    get:
      tags:
        - Calendar
      summary: Obtém URL de autorização OAuth do Google
      description: Gera URL para iniciar o fluxo de autorização OAuth do Google Calendar
      responses:
        '200':
          description: URL de autorização gerada
          content:
            application/json:
              schema:
                type: object
                properties:
                  authUrl:
                    type: string
                    format: uri
                    example: https://accounts.google.com/o/oauth2/v2/auth?client_id=...
        '500':
          $ref: '#/components/responses/InternalError'

  /api/calendar/oauth-callback:
    post:
      tags:
        - Calendar
      summary: Processa callback OAuth do Google
      description: |
        Processa o código de autorização do Google OAuth e salva os tokens
        criptografados no banco de dados.
        
        **Rate Limit:** 10 requisições por 15 minutos por IP
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - tenantId
              properties:
                code:
                  type: string
                  minLength: 20
                  maxLength: 200
                  description: Código de autorização do Google OAuth
                tenantId:
                  type: string
                  format: uuid
                  description: ID do tenant
      responses:
        '200':
          description: Google Calendar conectado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Google Calendar connected successfully
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/calendar/check-availability:
    post:
      tags:
        - Calendar
      summary: Verifica disponibilidade no Google Calendar
      description: Verifica se há disponibilidade no Google Calendar para o horário especificado
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tenantId
                - startTime
                - endTime
              properties:
                tenantId:
                  type: string
                  format: uuid
                startTime:
                  type: string
                  format: date-time
                  example: '2026-02-15T14:30:00.000Z'
                endTime:
                  type: string
                  format: date-time
                  example: '2026-02-15T15:30:00.000Z'
      responses:
        '200':
          description: Disponibilidade verificada
          content:
            application/json:
              schema:
                type: object
                properties:
                  isAvailable:
                    type: boolean
                    description: true se o horário está disponível
        '400':
          description: Google Calendar não conectado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/calendar/disconnect:
    post:
      tags:
        - Calendar
      summary: Desconecta Google Calendar
      description: Remove a conexão do Google Calendar do tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tenantId
              properties:
                tenantId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Google Calendar desconectado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Google Calendar disconnected
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/user/{userId}:
    get:
      tags:
        - Authentication
      summary: Obtém informações do usuário
      description: Retorna informações do usuário incluindo permissões
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Informações do usuário
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/check-permission:
    post:
      tags:
        - Authentication
      summary: Verifica permissão do usuário
      description: Verifica se o usuário tem uma permissão específica
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - permission
              properties:
                userId:
                  type: string
                  format: uuid
                permission:
                  type: object
                  required:
                    - resource
                    - action
                  properties:
                    resource:
                      type: string
                      example: appointments
                    action:
                      type: string
                      enum: [create, read, update, delete]
                      example: create
      responses:
        '200':
          description: Resultado da verificação
          content:
            application/json:
              schema:
                type: object
                properties:
                  hasPermission:
                    type: boolean
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/roles:
    get:
      tags:
        - Authentication
      summary: Lista todas as funções
      description: Retorna todas as funções (roles) disponíveis no sistema
      responses:
        '200':
          description: Lista de funções
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/users:
    post:
      tags:
        - Authentication
      summary: Cria um novo usuário
      description: Cria um novo usuário no sistema (requer permissão users.create)
      security:
        - userAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - name
                - tenantId
                - roleId
                - createdByUserId
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
                tenantId:
                  type: string
                  format: uuid
                roleId:
                  type: string
                  format: uuid
                createdByUserId:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Usuário criado
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Registra evento de login
      description: Registra um evento de login para auditoria
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - tenantId
              properties:
                userId:
                  type: string
                  format: uuid
                tenantId:
                  type: string
                  format: uuid
                ipAddress:
                  type: string
                  example: 192.168.1.1
                userAgent:
                  type: string
                  example: Mozilla/5.0...
      responses:
        '200':
          description: Login registrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    userAuth:
      type: apiKey
      in: header
      name: userId
      description: ID do usuário autenticado

  schemas:
    AppointmentInput:
      type: object
      required:
        - id
        - customerName
        - phoneNumber
        - serviceId
        - serviceName
        - date
        - status
        - value
      properties:
        id:
          type: string
          format: uuid
        customerName:
          type: string
          example: João Silva
        phoneNumber:
          type: string
          example: '11999999999'
        serviceId:
          type: string
          format: uuid
        serviceName:
          type: string
          example: Corte de Cabelo
        date:
          type: string
          format: date-time
          example: '2026-02-15T14:30:00.000Z'
        status:
          type: string
          enum: [confirmed, pending, cancelled]
          example: confirmed
        value:
          type: number
          format: double
          example: 50.00

    Appointment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        cliente_nome:
          type: string
        cliente_fone:
          type: string
        servico_id:
          type: string
          format: uuid
        servico_nome:
          type: string
        data_hora:
          type: string
          format: date-time
        status:
          type: string
          enum: [confirmed, pending, cancelled]
        valor:
          type: number
          format: double
        google_calendar_event_id:
          type: string
          nullable: true
        google_calendar_synced:
          type: boolean
        google_calendar_sync_error:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        tenantId:
          type: string
          format: uuid
        roleId:
          type: string
          format: uuid
        roleName:
          type: string
          enum: [admin, owner, manager, staff, readonly]
        isActive:
          type: boolean
        permissions:
          type: array
          items:
            type: string
          example: [appointments.create, appointments.read]

    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          enum: [admin, owner, manager, staff, readonly]
        description:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
          description: Mensagem de erro

  responses:
    Unauthorized:
      description: Autenticação requerida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Authentication required

    Forbidden:
      description: Sem permissão
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Permission denied

    NotFound:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not found

    InternalError:
      description: Erro interno do servidor
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Internal server error
